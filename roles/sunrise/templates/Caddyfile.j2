# global options block: https://caddyserver.com/docs/caddyfile/options
{
	servers {
		protocol {
			experimental_http3
		}
	}
	email 	{{ admin_email }}
}

# reusable snippets: https://caddyserver.com/docs/caddyfile/concepts#snippets
(cache-plz) {
	@cachedFiles {
		path *.jpg *.jpeg
	}
	@checkCache {
		path *.css
	}
	header @cachedFiles Cache-Control "public, max-age=31536000, must-revalidate"
	header @checkCache Cache-Control no-cache
}

(boilerplate) {
	encode gzip zstd
	file_server
	import cache-plz
}

# redirect no-www to www
(redir-to-www) {
	{args.0} {
		redir https://www.{args.0}{uri} permanent
	}
}

# start site blocks

# local test page, using local certs
{{ local_hostname }}.{{ test_domain }} {
	root * /srv/{{ test_domain }}/{{ test_subdomain }}/public/
	import boilerplate
	# https://caddyserver.com/docs/caddyfile/directives/templates
	# can't use default double curly braces b/c Ansible uses them
	templates {
		between (( ))
	}
	tls internal
}

# test page
{{ test_subdomain }}.{{ test_domain }} {
	root * /srv/{{ test_domain }}/{{ test_subdomain }}/public/
	import boilerplate
	header {
		Content-Security-Policy: "default-src 'none'; connect-src 'self'; img-src data:; style-src 'self'; frame-ancestors 'none'"
		X-Content-Type-Options: "nosniff"
	}
	# https://caddyserver.com/docs/caddyfile/directives/templates
	# can't use default double curly braces b/c Ansible uses them
	templates {
		between (( ))
	}
}

# handcoded Rhode Island site
www.sunrisepvd.com {
	root * /srv/sunrisepvd.com/www/public
	import boilerplate
	php_fastcgi unix/{{ php_fpm_unix_socket }}
}
import redir-to-www sunrisepvd.com

# Hugo sites
www.maximumethics.dev {
	root * /srv/maximumethics.dev/www/public
	encode gzip zstd
	file_server browse
	import cache-plz
}
import redir-to-www maximumethics.dev
